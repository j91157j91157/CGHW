<!DOCTYPE html>
<html>
<head>
    <title>test</title>
    <link rel="shortcut icon" href="http://i.imgur.com/jnjsKvZ.png">
</head>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/84/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://rawgit.com/mrdoob/three.js/master/examples/js/loaders/MTLLoader.js"></script>
<script src="https://rawgit.com/mrdoob/three.js/master/examples/js/loaders/OBJLoader.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="build.html"></script>

<div id="info">HW5 破壞死光
  <br>
  <button id="toggle" style="width:20%">Toggle</button>
  <button id="toggle1" style="width:20%">Toggle lamp</button>
</div>

<script type="x-shader/x-vertex" id="vertexShaderDepth">
    varying vec2 vUV;

    void main() {
        vUV = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
</script>

<script type="x-shader/x-fragment" id="fragmentShaderDepth">
    uniform sampler2D texture;
    varying vec2 vUV;

    vec4 pack_depth(const in float depth) {
        const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);
        const vec4 bit_mask = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);
        vec4 res = fract(depth * bit_shift);
        res -= res.xxyz * bit_mask;
        return res;
    }

    void main() {
        vec4 pixel = texture2D(texture, vUV);
        if (pixel.a < 0.5) discard;
        gl_FragData[0] = pack_depth(gl_FragCoord.z);
    }
</script>


<style>
	body {
		overflow: hidden
	}

	#info {
	  position: absolute;
	  top: 0px;
	  width: 100%;
	  padding: 10px;
	  text-align: center;
	  color: #ffff00
	}
</style>

<body>
<script>
  var renderer, camera, controls, scene;
  var Table, PenHolder, RemoteControl;
  var roomLight, lampLight;
  var toggleRoom = false, toggleLamp = true;
  var pickables = [];
  var raycaster = new THREE.Raycaster();
  var mouse = new THREE.Vector2();
  var button, button2;


  init();
  animate();

  $("#toggle").click(function() {
    toggleRoom = ! toggleRoom;
  });

  $("#toggle1").click(function() {
    toggleLamp = ! toggleLamp;
  });


  function init() {

    renderer = new THREE.WebGLRenderer({
      antialias: true
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x404040);
    document.body.appendChild(renderer.domElement);

    camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 1, 1000);
    camera.position.set(-50, 50, 50); // important

    controls = new THREE.OrbitControls(camera, renderer.domElement);

    scene = new THREE.Scene();

    let axes = new THREE.AxisHelper(100);
    //scene.add(axes);

    let gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
    //scene.add(gridXZ);

    // floor
    var loader = new THREE.TextureLoader();
    loader.setCrossOrigin ('');
    var floorTexture = loader.load('texture/HW5/floor.jpg');
    var floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200, 140, 140), new THREE.MeshLambertMaterial({
      map: floorTexture,
      side: THREE.DoubleSide
    }));
    floor.rotation.x = -Math.PI / 2;
    scene.add(floor);

    // wall
    var wallTexture = loader.load('texture/HW5/wall.jpg');
    var wall_negz = new THREE.Mesh(new THREE.PlaneGeometry(200, 100, 140, 140), new THREE.MeshLambertMaterial({
      map: wallTexture
    }));
    wall_negz.position.y = 50;
    var wall_posz = wall_negz.clone();
    var wall_posx = wall_negz.clone();
    var wall_negx = wall_negz.clone();

    wall_negz.position.z = -100;
    wall_posz.rotation.x = Math.PI;
    wall_posz.position.z = 100;
    wall_negx.position.x = -100;
    wall_negx.rotation.y = Math.PI / 2;
    wall_posx.position.x = 100;
    wall_posx.rotation.y = -Math.PI / 2;
    scene.add(wall_negz);
    scene.add(wall_posz);
    scene.add(wall_negx);
    scene.add(wall_posx);


    // lighting
    var light = new THREE.AmbientLight(0x505050); // soft white light
    scene.add(light);

    // room light
    roomLight = new THREE.SpotLight(0xffffff);
    roomLight.position.set(-25, 100, 25);

    //roomLight.angle = Math.PI / 2; ??
    roomLight.angle = Math.PI / 2.5;
    roomLight.penumbra = 0.25;

    roomLight.castShadow = true;
    roomLight.shadow.mapSize.width = 1024;
    roomLight.shadow.mapSize.height = 1024;

    roomLight.shadow.camera.near = 10;
    roomLight.shadow.camera.far = 500;
    roomLight.shadow.camera.fov = 50;

    scene.add(roomLight);
    //scene.add(new THREE.SpotLightHelper(roomLight));
    //scene.add ( new THREE.CameraHelper (roomLight.shadow.camera) );

    // lamp light
    lampLight = new THREE.SpotLight(0xffffff);
    lampLight.position.set(-20, 47, -13);

    lampLight.angle = Math.PI / 4; //角度改小一點
    lampLight.penumbra = 0.25;
    lampLight.distance = 35; //從400改成了30
    lampLight.decay = 1; //改0會穿過桌子
    //lampLight.intensity = 2; 在 animate 裡面有設 toggle ，限制了intensity

    lampLight.castShadow = true;
    lampLight.shadow.mapSize.width = 1024;
    lampLight.shadow.mapSize.height = 1024;

    lampLight.shadow.camera.near = 1;
    lampLight.shadow.camera.far = 20;
    lampLight.shadow.camera.fov = 100;

    scene.add(lampLight);
    //scene.add(new THREE.SpotLightHelper(lampLight));
    //scene.add ( new THREE.CameraHelper (lampLight.shadow.camera) );



    // model
		var onProgress = function(xhr) {
			if (xhr.lengthComputable) {
				var percentComplete = xhr.loaded / xhr.total * 100;
				console.log(Math.round(percentComplete, 2) + '% downloaded');
			}
		};
		var onError = function(xhr) {};
		var mtlLoader = new THREE.MTLLoader();
		mtlLoader.setPath('model/HW5/');
		mtlLoader.load('lamp.mtl', function(materials) {
			materials.preload();
			var objLoader = new THREE.OBJLoader();
			objLoader.setMaterials(materials);
			objLoader.setPath('model/HW5/');
			objLoader.load('lamp.obj', function(object) {
				let model = unitize (object, 20);
        model.position.set(-22, 30, -15);
        model.rotation.y = -Math.PI / 4;
        model.traverse (
         function (mesh) {
            if (mesh instanceof THREE.Mesh) {
              mesh.castShadow = true;
              mesh.receiveShadow = true;
            }
          }
        );
				scene.add(model);
				//scene.add (new THREE.BoxHelper (model));

				object.traverse (
					function(mesh) {
						if (mesh instanceof THREE.Mesh) {
							mesh.material.side = THREE.DoubleSide;
						}
				});
			}, onProgress, onError);
		});

    window.addEventListener('resize', onWindowResize, false);
    document.addEventListener('mousedown', onDocumentMouseDown, false);
    document.addEventListener('mousemove', onDocumentMouseMove, false);

    Table = build_table();
    PenHolder = build_penHolder();
    PenHolder.position.set(-10 ,30.5, -15);
    RemoteControl = build_remoteControl();
    //RemoteControl.position.y = 50;
    RemoteControl.position.set(20, 30.25, 15);

    // shadow related
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    floor.receiveShadow = true;
    wall_negz.receiveShadow = true;
    wall_posz.receiveShadow = true;
    wall_negx.receiveShadow = true;
    wall_posx.receiveShadow = true;
    Table.traverse (
     function (mesh) {
        if (mesh instanceof THREE.Mesh) {
          mesh.castShadow = true;
          mesh.receiveShadow = true;
        }
      }
    );
    PenHolder.traverse (
     function (mesh) {
        if (mesh instanceof THREE.Mesh) {
          mesh.castShadow = true;
          mesh.receiveShadow = true;
        }
      }
    );
    RemoteControl.traverse (
     function (mesh) {
        if (mesh instanceof THREE.Mesh) {
          mesh.castShadow = true;
          mesh.receiveShadow = true;
        }
      }
    );

    scene.add(Table);
    scene.add(PenHolder);
    scene.add(RemoteControl);
  }

  function onDocumentMouseDown(event) {
    event.preventDefault();
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

    // find intersections
    raycaster.setFromCamera(mouse, camera);
    var intersects = raycaster.intersectObjects(pickables, true);
    if (intersects.length > 0) {
      let picked = intersects[0].object.parent.name;
      switch (picked) {
      case 'cyan':
        button.toggle();
        toggleRoom = ! toggleRoom;
        break;
      case 'purple':
        button2.toggle();
        toggleLamp = ! toggleLamp;
        break;
      }
    }
  }

  function onDocumentMouseMove(event) {
    event.preventDefault();
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);

    var intersects = raycaster.intersectObjects(pickables, true);
    if (intersects.length > 0) document.body.style.cursor = 'pointer';
    else document.body.style.cursor = 'auto';
  }

  function animate() {
    roomLight.intensity = (toggleRoom === true) ? 1 : 0;
    lampLight.intensity = (toggleLamp === true) ? 3.5 : 0;

    roomLight.castShadow = (toggleRoom === true) ? 1 : 0;
    lampLight.castShadow = (toggleLamp === true) ? 1 : 0;

    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }


</script>

</body>
</html>
