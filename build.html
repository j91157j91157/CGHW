class Button {
  constructor(color, name) {
    this.on = false;
    this.hsl = color.getHSL();
    this.obj = this.makeButton(name);
  }

  get isOn() {
    return this.on;
  }

  toggle() {
    this.on = !this.on;
    this.update();
   }


  update() {
    if (this.on) {
      this.obj.scale.set (1,0.5,1);
      this.obj.children[0].material.color.setHSL
        (this.hsl.h, 0, 1);
    } else {
      this.obj.scale.set(1,1,1);
      this.obj.children[0].material.color.setHSL
         (this.hsl.h, this.hsl.s, this.hsl.l);
    }
  }


  makeButton(name) {
    let mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.5, 32),
      new THREE.MeshBasicMaterial());
    let button = new THREE.Object3D();
    button.add(mesh);
    mesh.material.color.setHSL (this.hsl.h, this.hsl.s, this.hsl.l)
    mesh.position.y = 0.5;
    button.name = name;  // a string
    return button;
  }
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function unitize (object, targetSize) {
  // find bounding box of 'object'
  var box3 = new THREE.Box3();
  box3.setFromObject (object);
  var size = new THREE.Vector3();
  size.subVectors (box3.max, box3.min);
  var center = new THREE.Vector3();
  center.addVectors(box3.max, box3.min).multiplyScalar (0.5);
  console.log ('center: ' + center.x + ', '+center.y + ', '+center.z );
  console.log ('size: ' + size.x + ', ' +  size.y + ', '+size.z );
  // uniform scaling according to objSize
  var objSize = Math.max (size.x, size.y, size.z);
  var scaleSet = targetSize/objSize;
  var theObject =  new THREE.Object3D();
  theObject.add (object);
  object.scale.set (scaleSet, scaleSet, scaleSet);
  object.position.set (-center.x*scaleSet, -center.y*scaleSet + size.y/2*scaleSet, -center.z*scaleSet);
  return theObject;
}

function build_table() {
  var table = new THREE.Object3D();
  //table total size 60, 30, 40
  var loader = new THREE.TextureLoader();
  loader.setCrossOrigin ('');
  var materialArray_base = [
    new THREE.MeshPhongMaterial({ // +x
      map: loader.load('texture/HW5/base_x.png')
    }),
    new THREE.MeshPhongMaterial({ // -x
      map: loader.load('texture/HW5/base_x.png')
    }),
    new THREE.MeshPhongMaterial({ // +y
      map: loader.load('texture/HW5/base_y.png')
    }),
    new THREE.MeshPhongMaterial({ // -Y
      map: loader.load('texture/HW5/base_y.png')
    }),
    new THREE.MeshPhongMaterial({ // +z
      map: loader.load('texture/HW5/base_z.png')
    }),
    new THREE.MeshPhongMaterial({ // -Z
      map: loader.load('texture/HW5/base_z.png')
    })
  ];

  var material_base = new THREE.MultiMaterial(materialArray_base);

  var materialArray_cabinet = [
    new THREE.MeshLambertMaterial({ // +x
      map: loader.load('texture/HW5/cabinet_x.png')
    }),
    new THREE.MeshLambertMaterial({ // -x
      map: loader.load('texture/HW5/cabinet_x.png')
    }),
    new THREE.MeshLambertMaterial({ // +y
      map: loader.load('texture/HW5/cabinet_y.png')
    }),
    new THREE.MeshLambertMaterial({ // -Y
      map: loader.load('texture/HW5/cabinet_y.png')
    }),
    new THREE.MeshLambertMaterial({ // +z
      map: loader.load('texture/HW5/cabinet_z.png')
    }),
    new THREE.MeshLambertMaterial({ // -Z
      map: loader.load('texture/HW5/cabinet_z.png')
    })
  ];

  var material_cabinet = new THREE.MultiMaterial(materialArray_cabinet);

  var material_leg = new THREE.MeshLambertMaterial({
    map: loader.load('texture/HW5/table_leg.png')
  });

  var base = new THREE.Mesh(new THREE.BoxGeometry(64, 4, 44), material_base);
  base.position.y = 28;

  var table_leg_1 = new THREE.Mesh(new THREE.BoxGeometry(4, 26, 4), material_leg);
  var table_leg_2 = table_leg_1.clone();
  table_leg_1.position.set(-30, 13, -20);
  table_leg_2.position.set(-30, 2, -5);
  table_leg_2.rotation.x = Math.PI / 2;

  var cabinet = new THREE.Mesh(new THREE.BoxGeometry(22, 26, 42), material_cabinet);
  cabinet.position.set(21, 13, -1);
  var cabinet_surface_1 = new THREE.Mesh(new THREE.BoxGeometry(22, 6, 2), new THREE.MeshLambertMaterial({
    map: loader.load('texture/HW5/cabinet_surface_1.png')
  }));
  cabinet_surface_1.position.set(21, 22, 21);
  var cabinet_surface_2 = new THREE.Mesh(new THREE.BoxGeometry(22, 13, 2), new THREE.MeshLambertMaterial({
    map: loader.load('texture/HW5/cabinet_surface_2.png')
  }));
  cabinet_surface_2.position.set(21, 11, 21);

  table.add(base);
  table.add(table_leg_1);
  table.add(table_leg_2);
  table.add(cabinet);
  table.add(cabinet_surface_1);
  table.add(cabinet_surface_2);

  return table;
}

function build_penHolder() {
  var penHolder = new THREE.Object3D();
  //penHolder total size 6, 8, 6
  var loader = new THREE.TextureLoader();
  loader.setCrossOrigin ('');

  var penHolder_texture = new THREE.MeshLambertMaterial({
    map: loader.load('texture/HW5/penHolder_texture.jpg')
    /*,wireframe: true*/
  });

  var sidemap = loader.load('texture/HW5/penHolder_texture_x.png');
  var penHolder_texture_x = new THREE.MeshLambertMaterial({
    map: sidemap,
    transparent: true,
    /*,wireframe: true*/
  });

  var base = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 4), penHolder_texture);
  var surface_posx = new THREE.Mesh(new THREE.BoxGeometry(1, 8, 6), penHolder_texture_x);
  var surface_negx = surface_posx.clone();
  var surface_posz = new THREE.Mesh(new THREE.BoxGeometry(4, 8, 1), penHolder_texture);
  var surface_negz = surface_posz.clone();
  surface_posx.position.set(2.5, 3.5, 0);
  surface_negx.position.set(-2.5, 3.5, 0);
  surface_posz.position.set(0, 3.5, 2.5);
  surface_negz.position.set(0, 3.5, -2.5);

  var pencil = new THREE.Object3D();
  var pencil_texture = new THREE.MeshLambertMaterial({
    map: loader.load('texture/HW5/pencil_texture.png')
  });
  var penBody = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 8, 6), pencil_texture);
  var penHead = new THREE.Mesh(new THREE.CylinderGeometry(0, 0.5, 1, 6), pencil_texture);
  penHead.position.y = 4.5;
  pencil.add(penBody);
  pencil.add(penHead);
  pencil.position.set(-1.5, 4.5, -1.5);
  var pencil_avatar = pencil.clone();
  pencil_avatar.position.set(0, 4.5, 0);
  pencil_avatar.rotation.x = Math.PI/7;
  pencil_avatar.rotation.z = Math.PI/7.5;

  surface_posx.customDepthMaterial = new THREE.ShaderMaterial({  //小提醒：不可以用 Object3D ，必須是一個 Mesh
      uniforms: {
          texture: {
              type: 't',
              value: sidemap
          }
      },
      vertexShader: document.getElementById('vertexShaderDepth').textContent,
      fragmentShader: document.getElementById('fragmentShaderDepth').textContent
  });

  penHolder.add(base);
  penHolder.add(surface_posx);
  penHolder.add(surface_negx);
  penHolder.add(surface_posz);
  penHolder.add(surface_negz);
  penHolder.add(pencil);
  penHolder.add(pencil_avatar);



  return penHolder;
}

function build_remoteControl() {
  var remoteControl = new THREE.Object3D();
  var loader = new THREE.TextureLoader();
  loader.setCrossOrigin ('');
  var base = new THREE.Mesh(new THREE.BoxGeometry(2, 0.5, 4), new THREE.MeshLambertMaterial({color: 0x808080}));

  button = new Button(new THREE.Color (0x12ffff), 'cyan');
  scene.add(button.obj);
  button.obj.position.z = -1;
  pickables.push(button.obj);

  button2 = new Button(new THREE.Color (0xff12ff), 'purple');
  scene.add(button2.obj);
  button2.obj.position.z = 1;
  pickables.push(button2.obj);

  remoteControl.add(base);
  remoteControl.add(button.obj);
  remoteControl.add(button2.obj);


  return remoteControl;
}
